<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual AI Regression Testing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 1200px;
        }
        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        .upload-zone {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9fa;
            margin: 20px 0;
        }
        .upload-zone:hover {
            border-color: #0056b3;
            background: #e9ecef;
        }
        .upload-zone.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        .btn-custom {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
            color: white;
        }
        .analysis-controls {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        .results-container {
            margin: 20px 0;
            display: none;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-running { background-color: #ffc107; }
        .status-completed { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .difference-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <div class="header">
                <h1><i class="bi bi-eye"></i> Visual AI Regression Testing</h1>
                <p class="mb-0">Advanced image comparison and analysis for web applications</p>
            </div>
            
            <div class="p-4">
                <!-- Upload Section -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="upload-zone" id="upload1" onclick="document.getElementById('file1').click()">
                            <i class="bi bi-cloud-upload display-4 text-primary"></i>
                            <h5>Baseline Image</h5>
                            <p class="text-muted">Click to upload or drag & drop</p>
                            <input type="file" id="file1" accept="image/*" style="display: none;">
                            <div id="preview1" class="mt-3"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="upload-zone" id="upload2" onclick="document.getElementById('file2').click()">
                            <i class="bi bi-cloud-upload display-4 text-primary"></i>
                            <h5>Current Image</h5>
                            <p class="text-muted">Click to upload or drag & drop</p>
                            <input type="file" id="file2" accept="image/*" style="display: none;">
                            <div id="preview2" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Controls -->
                <div class="analysis-controls">
                    <h5><i class="bi bi-gear"></i> Analysis Settings</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <label for="sensitivity" class="form-label">Sensitivity</label>
                            <input type="range" class="form-range" id="sensitivity" min="0.1" max="1.0" step="0.1" value="0.8">
                            <small class="text-muted">Current: <span id="sensitivityValue">0.8</span></small>
                        </div>
                        <div class="col-md-4">
                            <label for="analysisType" class="form-label">Analysis Type</label>
                            <select class="form-select" id="analysisType">
                                <option value="comprehensive">Comprehensive</option>
                                <option value="quick">Quick</option>
                                <option value="detailed">Detailed</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="layoutShifts" checked>
                                <label class="form-check-label" for="layoutShifts">
                                    Detect Layout Shifts
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="colorChanges" checked>
                                <label class="form-check-label" for="colorChanges">
                                    Detect Color Changes
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="textChanges" checked>
                                <label class="form-check-label" for="textChanges">
                                    Detect Text Changes
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-custom btn-lg" id="analyzeBtn" disabled>
                            <i class="bi bi-play-circle"></i> Start Analysis
                        </button>
                    </div>
                </div>

                <!-- Progress Section -->
                <div class="progress-container" id="progressContainer">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="mt-3">
                                <span class="status-indicator status-running"></span>
                                <span id="progressStatus">Analysis in progress...</span>
                            </h5>
                            <p class="text-muted" id="progressDetail">Please wait while we analyze your images</p>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="results-container" id="resultsContainer">
                    <h5><i class="bi bi-chart-line"></i> Analysis Results</h5>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSessionId = null;
        let uploadedFiles = {file1: null, file2: null};

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUploads();
            setupAnalysisControls();
        });

        function setupFileUploads() {
            const file1Input = document.getElementById('file1');
            const file2Input = document.getElementById('file2');
            const upload1Zone = document.getElementById('upload1');
            const upload2Zone = document.getElementById('upload2');

            // File input change handlers
            file1Input.addEventListener('change', (e) => handleFileSelect(e, 'file1', 'preview1'));
            file2Input.addEventListener('change', (e) => handleFileSelect(e, 'file2', 'preview2'));

            // Drag and drop handlers
            setupDragAndDrop(upload1Zone, file1Input, 'file1', 'preview1');
            setupDragAndDrop(upload2Zone, file2Input, 'file2', 'preview2');
        }

        function setupDragAndDrop(zone, input, fileKey, previewId) {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    handleFileSelect({target: input}, fileKey, previewId);
                }
            });
        }

        function handleFileSelect(event, fileKey, previewId) {
            const file = event.target.files[0];
            if (file) {
                uploadedFiles[fileKey] = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(previewId).innerHTML = 
                        `<img src="${e.target.result}" class="image-preview" alt="Preview">
                         <p class="mt-2 text-success"><i class="bi bi-check-circle"></i> ${file.name}</p>`;
                };
                reader.readAsDataURL(file);
                
                checkAnalyzeButton();
            }
        }

        function checkAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (uploadedFiles.file1 && uploadedFiles.file2) {
                analyzeBtn.disabled = false;
            }
        }

        function setupAnalysisControls() {
            const sensitivitySlider = document.getElementById('sensitivity');
            const sensitivityValue = document.getElementById('sensitivityValue');
            const analyzeBtn = document.getElementById('analyzeBtn');

            sensitivitySlider.addEventListener('input', function() {
                sensitivityValue.textContent = this.value;
            });

            analyzeBtn.addEventListener('click', startAnalysis);
        }

        async function startAnalysis() {
            try {
                // First upload files
                const formData = new FormData();
                formData.append('image1', uploadedFiles.file1);
                formData.append('image2', uploadedFiles.file2);

                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const uploadResult = await uploadResponse.json();
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error);
                }

                currentSessionId = uploadResult.session_id;

                // Then start analysis
                const analysisConfig = {
                    sensitivity: parseFloat(document.getElementById('sensitivity').value),
                    analysis_type: document.getElementById('analysisType').value,
                    detect_layout_shifts: document.getElementById('layoutShifts').checked,
                    detect_color_changes: document.getElementById('colorChanges').checked,
                    detect_text_changes: document.getElementById('textChanges').checked
                };

                const analyzeResponse = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(analysisConfig)
                });

                const analyzeResult = await analyzeResponse.json();
                if (!analyzeResult.success) {
                    throw new Error(analyzeResult.error);
                }

                // Show progress and start polling
                showProgress();
                pollStatus(currentSessionId);

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
        }

        async function pollStatus(sessionId) {
            try {
                const response = await fetch(`/status/${sessionId}`);
                const result = await response.json();

                if (result.status === 'running') {
                    setTimeout(() => pollStatus(sessionId), 2000);
                } else if (result.status === 'completed') {
                    hideProgress();
                    showResults(result.results);
                } else if (result.status === 'error') {
                    hideProgress();
                    alert('Analysis failed: ' + result.error);
                    document.getElementById('analyzeBtn').disabled = false;
                }
            } catch (error) {
                setTimeout(() => pollStatus(sessionId), 5000);
            }
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function showResults(results) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            
            let html = '<div class="row">';
            
            // Metrics
            if (results.similarity_score !== undefined) {
                html += `
                    <div class="col-md-4">
                        <div class="metric-card">
                            <h6><i class="bi bi-percent"></i> Similarity Score</h6>
                            <h3 class="text-primary">${(results.similarity_score * 100).toFixed(1)}%</h3>
                        </div>
                    </div>
                `;
            }
            
            if (results.differences_count !== undefined) {
                html += `
                    <div class="col-md-4">
                        <div class="metric-card">
                            <h6><i class="bi bi-exclamation-triangle"></i> Differences Found</h6>
                            <h3 class="text-warning">${results.differences_count}</h3>
                        </div>
                    </div>
                `;
            }
            
            if (results.analysis_duration !== undefined) {
                html += `
                    <div class="col-md-4">
                        <div class="metric-card">
                            <h6><i class="bi bi-clock"></i> Analysis Time</h6>
                            <h3 class="text-info">${results.analysis_duration.toFixed(2)}s</h3>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Difference image
            if (results.difference_image_base64) {
                html += `
                    <div class="mt-4">
                        <h6><i class="bi bi-image"></i> Difference Visualization</h6>
                        <div class="text-center">
                            <img src="${results.difference_image_base64}" class="difference-image" alt="Difference Image">
                        </div>
                    </div>
                `;
            }
            
            // Download button
            html += `
                <div class="mt-4 text-center">
                    <button class="btn btn-success" onclick="downloadResults()">
                        <i class="bi bi-download"></i> Download Complete Report
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="resetAnalysis()">
                        <i class="bi bi-arrow-clockwise"></i> New Analysis
                    </button>
                </div>
            `;
            
            resultsContent.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        function downloadResults() {
            if (currentSessionId) {
                window.open(`/download/${currentSessionId}`, '_blank');
            }
        }

        function resetAnalysis() {
            // Reset everything
            currentSessionId = null;
            uploadedFiles = {file1: null, file2: null};
            
            document.getElementById('file1').value = '';
            document.getElementById('file2').value = '';
            document.getElementById('preview1').innerHTML = '';
            document.getElementById('preview2').innerHTML = '';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';
        }
    </script>
</body>
</html>
